# Sequelize

> ì´ë²ˆ í”„ë¡œì íŠ¸ì—ì„œ MYSQLì„ ë…¸ë“œì—ì„œ ì“°ë ¤ê³  í•œë‹¤...  
> = ì•Œì•„ì•¼ í•œë‹¤.

- Nodejsì—ì„œ mysqlì„ ë‹¤ë£¨ëŠ” ormì´ë‹¤.
- mongooseì™€ ë‹¤ë¥´ê²Œ ê´€ê³„í˜•ì´ë‹ˆê¹Œ ormì´ë‹¤.

## ë§¤ìš° í¸ë¦¬í•œ ì´ë‹ˆì…œë¼ì´ì¦ˆ
```
$ npm i sequelize mysql2
$ npm i -g sequelize-cli
$ npx sequelize init
```
- í•„ìš”í•œ íŒŒì¼ê³¼ í´ë”ë“¤ì´ ì•Œì•„ì„œ ì„¤ì¹˜ëœë‹¤.
- ê·¼ë° -gëŠ” ì•ˆë¶™ì—¬ë„ ë  ê²ƒ ê°™ì€ë° ì™œ ë¶™ì˜€ì„ê¹Œ
> - ì°¾ì•„ë³´ë‹ˆ ì—­ì‹œ í•„ìš”ì—†ì—ˆë‹¤. ì˜¤íˆë ¤ -Dë¥¼ ë¶™ì´ëŠ”ê²Œ (ê°œì¸ì ìœ¼ë¡œ) ë‚«ë‹¤.  


sequelize initì„ í•˜ê²Œ ë˜ë©´ ìƒˆ í´ë”ì™€ íŒŒì¼ë“¤ì´ ìƒì„±ëœë‹¤.  
![image1](/public/JS/sequelize1_1.png)  
(í”„ë¡œì íŠ¸ì— ì‹¤ì‹œê°„ ì ìš©ì¤‘..)
- config : sequelizeë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ í™˜ê²½ì„ ì„¤ì •í•˜ëŠ” ë¶€ë¶„ì´ë‹¤.
- models/index.js : Modelì„ ì •ì˜í•˜ê³  ê´€ê³„ë¥¼ ì„¤ì •í•˜ëŠ” ë¶€ë¶„ì´ë‹¤.

## models/index.js
> index.jsíŒŒì¼ì´ ìƒê²¨ë‚¬ë‹¤.
> ê°ê° ê¸°ëŠ¥ì„ ì•Œì•„ë³´ì
```
'use strict';

const fs = require('fs');
const path = require('path');
const Sequelize = require('sequelize');
const basename = path.basename(__filename);
// í™˜ê²½ë³€ìˆ˜, ì‹¤ì œ ë°°í¬í•  ë•ŒëŠ” 'production'ìœ¼ë¡œ ë°”ê¿”ì•¼í•œë‹¤.
const env = process.env.NODE_ENV || 'development';
const config = require(__dirname + '/../config/config.json')[env];
// db ê°ì²´ ìƒì„±
const db = {};

let sequelize;
//í™˜ê²½ë³€ìˆ˜ì— ë”°ë¼ ë‹¤ë¥´ê²Œ ì‘ìš©í•œë‹¤.
if (config.use_env_variable) {
  sequelize = new Sequelize(process.env[config.use_env_variable], config);
} else {
  sequelize = new Sequelize(config.database, config.username, config.password, config);
}

fs
  .readdirSync(__dirname)
  .filter(file => {
    return (file.indexOf('.') !== 0) && (file !== basename) && (file.slice(-3) === '.js');
  })
  .forEach(file => {
    const model = require(path.join(__dirname, file))(sequelize, Sequelize.DataTypes);
    db[model.name] = model;
  });

Object.keys(db).forEach(modelName => {
  if (db[modelName].associate) {
    db[modelName].associate(db);
  }
});

//ì‹œí€„ë¼ì´ì¦ˆ ê°ì²´ì— config íŒŒì¼ì— ìˆëŠ” ì„¤ì •ë“¤ì„ ë„£ì–´ì¤€ë‹¤.
db.sequelize = sequelize;
db.Sequelize = Sequelize;

//db ê°ì²´ì— ì‹œí€„ë¼ì´ì¦ˆ íŒ¨í‚¤ì§€ì™€ ê°ì²´ë¥¼ ë„£ê³  ëª¨ë“ˆë¡œ ì‚¬ìš©í•œë‹¤.
module.exports = db;
```

## config.json
```
{
  "development": {
    "username": "root",
    "password": null,
    "database": "database_development",
    "host": "127.0.0.1",
    "dialect": "mysql"
  },
  "test": {
    "username": "root",
    "password": null,
    "database": "database_test",
    "host": "127.0.0.1",
    "dialect": "mysql"
  },
  "production": {
    "username": "root",
    "password": null,
    "database": "database_production",
    "host": "127.0.0.1",
    "dialect": "mysql"
  }
}
```
ì—­ì‹œ í™˜ê²½ë³€ìˆ˜ì— ë”°ë¼ ë‹¤ë¥´ê²Œ ì‘ë™í•œë‹¤.

## ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±í•˜ê¸°
```
npx sequelize db:create
```
- ì¸í„°ë„·ì—ì„œ ë³¸ ëŒ€ë¡œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ìƒì„±í•´ë³´ì•˜ë‹¤.
```
TypeError [ERR_INVALID_ARG_TYPE]: The "data" argument must be of type string or an instance of Buffer, TypedArray, or DataView. Received type number (1234)
```
ì˜¤ìš°!ğŸ˜‚  
</br>
ëŒ€ì¶©..ì°¾ì•„ë³´ë‹ˆ..config.jsonì—ì„œ ë­”ê°€ë¥¼ ì˜ëª»í–ˆë‹¤ê³  í•œë‹¤.  
https://stackoverflow.com/questions/47049399/sequelize-dbmigrate-throw-typeerror-data-must-be-a-string-or-a-buffer  

ì´ìª½ì´ ë¬¸ì œì˜€ë‹¤.  
```
"password": 1234,
```  
->  
```
"password": "1234",
```  
ì†”ì§íˆ ì˜ì–´ í•´ì„ ì œëŒ€ë¡œ ëª»í–ˆëŠ”ë° ê°ìœ¼ë¡œ ë•Œë ¤ë§ì·„ë‹¤.  

í•´ê²°  

</br>

ì¸ì¤„ì•Œì•˜ìœ¼ë‚˜..
```
ERROR: Access denied for user 'root'@'localhost' (using password: YES)
```
ì˜¤ìš°!ğŸ˜‚ğŸ˜‚  
</br>
ë‚´ mysqlì„ ì§ì ‘ ë“¤ì–´ê°€ë³´ì•˜ë‹¤.  
![image4](/public/JS/sequelize4.PNG)   
ì•„ ì˜›ë‚ ì— ë¹„ë°€ë²ˆí˜¸ ë°”ê¿”ë†¨êµ¬ë‚˜  

```
"password": "ë‚´ë¹„ë°€ë²ˆí˜¸",
```  

ì§„ì§œ í•´ê²°!  
![image2](/public/JS/sequelize2.PNG)     
![image3](/public/JS/sequelize3.PNG)     

ormì„ ì‚¬ìš©í•˜ì—¬ ~~ì‰½ê²Œ?~~ dbë¥¼ ìƒì„±í•˜ì˜€ë‹¤.  

## sequelize-cliì„ ì´ìš©í•˜ì—¬ ëª¨ë¸ë§Œë“¤ê¸°
> ì¸í„°ë„·ì—ì„œ ë§ì´ ì°¾ì•„ë´¤ëŠ”ë° ê¸°ê» sequelize-cli ì„¤ì¹˜í•´ë†“ê³  ëª…ë ¹ì–´ë¡œ ëª¨ë¸ ìƒì„±ì€ ì˜ ì•ˆí•˜ë”ë€ë‹¤.  
> ê·¸ë˜ì„œ ë‚œ ì´ê±¸ë¡œ í•´ì•¼ê² ë‹¤  

https://sequelize.org/master/manual/migrations.html  

https://velog.io/@jeff0720/Sequelize-CLI%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EC%97%AC-%EA%B0%84%EB%8B%A8%ED%95%9C-User-API-%EB%A7%8C%EB%93%A4%EA%B8%B0-vdjpb8nl0k  
```
We will use model:generate command. This command requires two options:

name: the name of the model;
attributes: the list of model attributes.
Let's create a model named User.

npx sequelize-cli model:generate --name User --attributes firstName:string,lastName:string,email:string
```   
.......  
do it!  
```
$ npx sequelize model:generate --name Comment --attributes commentId:string,postId:string,userId:string,contents:string,date:date
```  
dateì˜ ë°ì´í„°íƒ€ì…ì„ ì°¾ì•„ë³´ê¸° ìœ„í•´ ì¡°ê¸ˆ ë” ì°¾ì•„ë³´ì•˜ë‹¤.  
mysqlì˜ DATETIMEì€ DATEë¡œ í†µìš©í•´ì„œ ì“°ëŠ” ê²ƒ ê°™ë‹¤.  
https://sequelize.org/v5/manual/data-types.html  
https://stackoverflow.com/questions/29652538/sequelize-js-timestamp-not-datetime   


### ëª¨ë¸ ìƒì„±!
- models/comment.js

```
'use strict';
const {
  Model
} = require('sequelize');
module.exports = (sequelize, DataTypes) => {
  class Comment extends Model {
    /**
     * Helper method for defining associations.
     * This method is not a part of Sequelize lifecycle.
     * The `models/index` file will call this method automatically.
     */
    static associate(models) {
      // define association here
    }
  };
  Comment.init({
    commentId: DataTypes.STRING,
    postId: DataTypes.STRING,
    userId: DataTypes.STRING,
    contents: DataTypes.STRING,
    date: DataTypes.DATE
  }, {
    sequelize,
    modelName: 'Comment',
  });
  return Comment;
};
```   
- migrations/ìƒì„±ë‚ ì§œ-create-comment.js
```
'use strict';
module.exports = {
  up: async (queryInterface, Sequelize) => {
    await queryInterface.createTable('Comments', {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: Sequelize.INTEGER
      },
      commentId: {
        type: Sequelize.STRING
      },
      postId: {
        type: Sequelize.STRING
      },
      userId: {
        type: Sequelize.STRING
      },
      contents: {
        type: Sequelize.STRING
      },
      date: {
        type: Sequelize.DATE
      },
      createdAt: {
        allowNull: false,
        type: Sequelize.DATE
      },
      updatedAt: {
        allowNull: false,
        type: Sequelize.DATE
      }
    });
  },
  down: async (queryInterface, Sequelize) => {
    await queryInterface.dropTable('Comments');
  }
};
```
GOOD!ğŸ‘  

### ëª¨ë¸ ìˆ˜ì •
- ì•„ ê·¼ë° sequelizeì—ì„œë„ mongooseì²˜ëŸ¼ ìë™ìœ¼ë¡œ idë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤ê³  í•œë‹¤. ê²Œë‹¤ê°€ ì´ê±´ createdAtì´ë‘ updatedAtê¹Œì§€ ìë™ìœ¼ë¡œ ìƒì„±í•´ì¤€ë‹¤!
> (ê´œíˆ useridë‘ dateë§Œë“¤ì—ˆë‹¤)
- ì“¸ë°ì—†ì´ ë§Œë“  useridë‘ dateëŠ” ë§Œë“¤ê³  ë‚œ ì´í›„ì— ìˆ˜ì •í•´ë„ migrateë§Œ ì•ˆí•˜ë©´ ìƒê´€ì—†ëŠ” ê²ƒ ê°™ì•„ì„œ ìˆ˜ì •í–ˆë‹¤.
## í…Œì´ë¸” ìƒì„±í•˜ê¸°
- sequelizeëŠ” ë§Œë“¤ì–´ë‚¸ ëª¨ë¸ë¡œ ì‹¤ì œ í…Œì´ë¸”ë„ ì§ì ‘ ìƒì„±í•´ì¤€ë‹¤!
```
npx sequelize db:migrate
```
```
Sequelize CLI [Node: 14.15.1, CLI: 6.2.0, ORM: 6.7.0]

Loaded configuration file "config\config.json".      
Using environment "development".
== 20211014155413-create-comment: migrating =======
== 20211014155413-create-comment: migrated (0.271s)
```
![image5](/public/JS/sequelize5.PNG)  
GOOD!!!!ğŸ‘ğŸ‘ğŸ‘

## dbì‚¬ìš©í•˜ê¸°
- ì›ë˜ mongooseë¡œ êµ¬í˜„ë˜ì–´ ìˆì—ˆê¸°ì— ê³µì‹ë¬¸ì„œ(https://sequelize.org/master/manual/model-querying-finders.html) ë¥¼ ë³´ê³  ë°”ê¿”ì£¼ê¸°ë§Œ í•˜ë©´ ëœë‹¤.


</br>

ì•”íŠ¼ ì—¬ì°¨ì €ì°¨í•´ì„œ

```
await Comment.create({
  postId: postId,
  contents: contents,
  userId: userId,
});
```
```
Executing (default): INSERT INTO `Comments` (`commentId`,`postId`,`userId`,`contents`,`createdAt`,`updatedAt`) VALUES (?,?,?,?,?,?);
```
![image6](/public/JS/sequelize6.PNG)  

ì„±ê³µğŸ‰  